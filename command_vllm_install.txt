# -----------------------------------------
# 1. Install system dependencies
# -----------------------------------------
apt-get update
apt-get install -y \
    build-essential \
    libnuma-dev \
    python3 \
    python3-pip \
    python3-venv \
    git \
    wget \
    curl

# -----------------------------------------
# 2. Set up working directory
# -----------------------------------------
mkdir -p /app/vllm_source
cd /app/vllm_source

# -----------------------------------------
# 3. Clone vLLM at compatible tag (v0.8.5)
# -----------------------------------------
git clone --branch v0.8.5 https://github.com/vllm-project/vllm.git .
# NOTE: v0.8.5 is the latest DeepSeek-OCR-compatible version

# -----------------------------------------
# 4. Create and activate Python virtual environment
# -----------------------------------------
python3 -m venv myenv
source myenv/bin/activate

# -----------------------------------------
# 5. Upgrade pip and install wheel & build tools
# -----------------------------------------
pip install --upgrade pip
pip install setuptools wheel packaging ninja build

# -----------------------------------------
# 6. Install PyTorch for CPU (no CUDA)
# -----------------------------------------
pip install torch==2.1.0 --index-url https://download.pytorch.org/whl/cpu

# -----------------------------------------
# 7. Install vLLM with CPU backend from source
# -----------------------------------------
export VLLM_TARGET_DEVICE=cpu
pip install -r requirements.txt
python setup.py install

# -----------------------------------------
# 8. Install DeepSeek-OCR required Python dependencies
# -----------------------------------------
pip install \
    addict \
    transformers==4.35.0 \
    accelerate==0.24.1 \
    xformers==0.0.23.post1 \
    einops

# -----------------------------------------
# 9. (Optional) Test if vLLM CLI loads correctly
# -----------------------------------------
vllm --help


